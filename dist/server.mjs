import Fe from'ip';import o from'picocolors';import Te from'cookie-parser';import Oe from'cors';import Ce from'dotenv';import D,{urlencoded}from'express';import Ae from'helmet';import {StatusCodes}from'http-status-codes';import {z as z$1,ZodError}from'zod';import {doubleCsrf}from'csrf-csrf';import he from'express-rate-limit';import {readFileSync}from'fs';import {join}from'path';function w(e){e.get("/",(r,t)=>{t.status(200).send(`
				<!DOCTYPE html>
				<html lang="en">
				<head>
						<meta charset="UTF-8">
						<meta name="viewport" content="width=device-width, initial-scale=1.0">
						<title>Welcome Page</title>
						<style>
								body {
										font-family: Arial, sans-serif;
										background-color: #f4f4f9;
										color: #333;
										margin: 0;
										padding: 0;
										display: flex;
										justify-content: center;
										align-items: center;
										height: 100vh;
								}
								.container {
										text-align: center;
										background: white;
										padding: 20px;
										border-radius: 10px;
										box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
								}
								h1 {
										color: #4CAF50;
								}
								p {
										font-size: 1.2em;
								}
						</style>
				</head>
				<body>
						<div class="container">
								<h1>Welcome to the Application</h1>
								<p>All the API routes start with <code>/</code></p>
								<p>For example: <code>/auth/login</code></p>
						</div>
				</body>
				</html>
    `);});}var ee=new Set([StatusCodes.NO_CONTENT]),re=e=>e>=200&&e<300;var x=class{constructor(r){this.res=r;}successResponse(r,t,n){return this.sendResponse({status:StatusCodes.OK,message:r,data:t,pagination:n})}unauthorizedResponse(r){return this.sendResponse({status:StatusCodes.UNAUTHORIZED,message:r})}forbiddenResponse(r){return this.sendResponse({status:StatusCodes.FORBIDDEN,message:r})}badResponse(r){return this.sendResponse({status:StatusCodes.BAD_REQUEST,message:r})}internalServerError(r="Internal Server Error"){return this.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:r})}sendResponse({status:r,message:t,data:n,pagination:s}){if(ee.has(r))return this.res.status(r).end();let a={status:r,success:re(r),message:t,...n!==void 0?{data:n}:{},...s?{pagination:s}:{}};return this.res.status(r).json(a)}};function ne(e,r,t,n){let s=new x(t);if(oe(e,r),e instanceof ZodError){ie(e,s);return}if(e.name==="ValidationError"){ae(e,s);return}if(e.name==="CastError"){le(e,s);return}if(e.name==="MongoError"||e.name==="MongoServerError"){me(e,s);return}if(e.code==="ECONNREFUSED"){ce(e,s);return}if(e.name==="JsonWebTokenError"){ue(e,s);return}if(e.name==="TokenExpiredError"){pe(e,s);return}if(e.name==="SyntaxError"&&e.message.includes("JSON")){de(e,s);return}if(e.code==="LIMIT_FILE_SIZE"){ge(e,s);return}if(e.code==="EBADCSRFTOKEN"){fe(e,s);return}if(e.status||e.statusCode){Ee(e,s);return}ve(e,s);}function se(e,r){new x(r).sendResponse({status:StatusCodes.NOT_FOUND,message:`Route ${e.method} ${e.originalUrl} not found`});}function L(e){return (r,t,n)=>{Promise.resolve(e(r,t,n)).catch(n);}}function j(e){e.use(se),e.use(ne);}function oe(e,r){let t=new Date().toISOString(),n=r.method,s=r.originalUrl,a=r.get("User-Agent")||"Unknown",p=r.ip||r.socket.remoteAddress||"Unknown";console.error(o.red("=".repeat(80))),console.error(o.red(`\u{1F6A8} ERROR OCCURRED AT: ${t}`)),console.error(o.yellow(`\u{1F4DD} REQUEST: ${n} ${s}`)),console.error(o.cyan(`\u{1F310} IP: ${p}`)),console.error(o.cyan(`\u{1F50D} User-Agent: ${a}`)),console.error(o.red(`\u274C ERROR NAME: ${e.name||"Unknown"}`)),console.error(o.red(`\u{1F4AC} ERROR MESSAGE: ${e.message||"No message"}`)),e.stack&&(console.error(o.gray("\u{1F4DA} STACK TRACE:")),console.error(o.gray(e.stack))),console.error(o.red("=".repeat(80)));}function ie(e,r){let t=e.issues.map(n=>({field:n.path.join("."),message:n.message}));r.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:t}});}function ae(e,r){let t=Object.values(e.issues||{}).map(n=>({field:n.path,message:n.message}));r.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:t}});}function le(e,r){r.badResponse(`Invalid ${e.path}: ${e.value}`);}function me(e,r){if(e.code===11e3){let t=Object.keys(e.keyValue||{})[0];r.sendResponse({status:StatusCodes.CONFLICT,message:`Duplicate value for field: ${t}`});return}r.internalServerError("Database operation failed");}function ce(e,r){r.sendResponse({status:StatusCodes.SERVICE_UNAVAILABLE,message:"Database connection failed. Please try again later."});}function ue(e,r){r.unauthorizedResponse("Invalid authentication token");}function pe(e,r){r.unauthorizedResponse("Authentication token has expired");}function de(e,r){r.badResponse("Invalid JSON format in request body");}function ge(e,r){r.badResponse("File size exceeds the allowed limit");}function fe(e,r){r.forbiddenResponse("Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.");}function Ee(e,r){let t=e.status||e.statusCode||StatusCodes.INTERNAL_SERVER_ERROR,n=e.message||"An error occurred";r.sendResponse({status:t,message:n});}function ve(e,r){r.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Something went wrong. Please try again later."});}function F(){process.on("uncaughtException",e=>{console.error(o.red("\u{1F6A8} UNCAUGHT EXCEPTION:")),console.error(o.red(e.name+": "+e.message)),console.error(o.gray(e.stack)),console.log(o.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("unhandledRejection",(e,r)=>{console.error(o.red("\u{1F6A8} UNHANDLED PROMISE REJECTION:")),console.error(o.red("Reason:"),e),console.error(o.yellow("Promise:"),r),console.log(o.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("SIGTERM",()=>{console.log(o.yellow("\u{1F6D1} SIGTERM received. Starting graceful shutdown...")),process.exit(0);}),process.on("SIGINT",()=>{console.log(o.yellow("\u{1F6D1} SIGINT received. Starting graceful shutdown...")),process.exit(0);});}var I=class{clientDomain=null;serverDomain=null;setClientDomain(r){this.clientDomain=r;}getClientDomain(){return this.clientDomain}setServerDomain(r){this.serverDomain=r;}getServerDomain(){return this.serverDomain}},Re=new I,y=Re;var v=class{static detectInputType(r){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)?"EMAIL":"USERNAME"}static OTPGenerator(r=4){if(r<4)throw new Error("The OTP length must be at least 4.");let t=Math.pow(10,r-1),n=Math.pow(10,r)-1;return Math.floor(Math.random()*(n-t+1)+t)}static OTPExpiry(r=5){let t=new Date;return new Date(t.getTime()+r*6e4)}static sameSiteCookieConfig(){try{let r=g=>/^(\d{1,3}\.){3}\d{1,3}$/.test(g);if(process.env.COOKIE_SETTINGS==="locally")return {sameSite:"lax",secure:!1};if(process.env.COOKIE_SETTINGS==="globally"&&process.env.COOKIE_DOMAIN){let g=process.env.COOKIE_DOMAIN,R=g.startsWith(".")?g.substring(1):g;return r(R)?{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:g}:{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:g}}let t=y.getClientDomain(),n=y.getServerDomain()||process.env.API_URL;if(!t)return {sameSite:"none",secure:!0};let s=new URL(t),a=new URL(n),p=a.protocol==="https:",E=g=>g.split(":")[0],c=g=>{let R=E(g);if(R==="localhost"||r(R))return R;let M=R.split(".");return M.length<2?R:M.slice(-2).join(".")},d=c(s.hostname),Y=c(a.hostname),C,T;return E(s.hostname)===E(a.hostname)?(C=E(a.hostname),T="lax"):d===Y&&!r(d)&&d!=="localhost"?(C="."+d,T="lax"):(C=E(a.hostname),T="none"),T==="none"&&(p=!0),{sameSite:T,secure:p,domain:C}}catch{return {sameSite:"lax",secure:true}}}};var{generateCsrfToken:G,validateRequest:ir,doubleCsrfProtection:z,invalidCsrfTokenError:ar}=doubleCsrf({getSecret:()=>process.env.SECRET,getSessionIdentifier:()=>process.env.SECRET,cookieName:"csrf-token",cookieOptions:{maxAge:36e5,sameSite:v.sameSiteCookieConfig().sameSite,secure:v.sameSiteCookieConfig().secure,...v.sameSiteCookieConfig().domain&&{domain:v.sameSiteCookieConfig().domain}},size:32,errorConfig:{message:"Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.",statusCode:403},getCsrfTokenFromRequest:e=>e.headers["x-csrf-token"]});var H=(()=>{let e=D.Router();return e.get("",L(async(r,t)=>{let n=G(r,t);new x(t).successResponse("CSRF token generated",n);})),e})();var K=[{path:"/csrf-token",router:H}];function P(e,r=""){let t=[];for(let{path:n,router:s}of K){let a=`${r}${n}`;e.use(a,s),s.stack.forEach(p=>{p.route&&Object.keys(p.route.methods).forEach(c=>{t.push({method:c.toUpperCase(),path:`${a}${p.route.path}`});});});}}var V={origin:function(e,r){!e||process.env.ORIGIN_URL.split(",").includes(e)?r(null,true):r(new Error("Not allowed by CORS"));},credentials:true,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","x-csrf-token","ngrok-skip-browser-warning"],maxAge:3600};function k(e){e.use((r,t,n)=>{let{method:s,url:a}=r,p=Date.now();console.log(`${o.green("\u2713")} ${s} ${a}`),t.on("finish",()=>{let E=Date.now()-p,c=t.statusCode,d;c>=500?d=o.red(c.toString()):c>=400?d=o.yellow(c.toString()):c>=300?d=o.cyan(c.toString()):c>=200?d=o.green(c.toString()):d=o.red("500"),console.log(`${o.green("\u2713")} ${s} ${a} ${d} in ${E}ms`);}),n();});}function _(e){let r=he({windowMs:9e5,max:100,message:"Too many requests, please try again later."});e.use(r);}var ye=(e,r,t)=>{let n=e.secure?"https":"http",s=e.headers.origin||e.headers.referer||"Unknown",a=s!=="Unknown"?new URL(s.toString()).origin:"Unknown",p=e.headers.host?`${n}://${e.headers.host}`:"Unknown";y.setClientDomain(a),y.setServerDomain(p),t();},B=ye;Ce.config();var l=D();l.use(Ae());l.use(D.json());l.use(urlencoded({extended:true}));l.use(D.urlencoded({extended:true}));l.use(Te());l.use(Oe(V));k(l);_(l);l.use(B);l.use(z);w(l);P(l);j(l);var q=l;var i={error:{required:{fieldIsRequired:e=>`${e} is required.`},limit:{stringMin:(e,r)=>`${e} must be at least ${r} characters.`,stringMax:(e,r)=>`${e} must not exceed ${r} characters.`,arrayMin:(e,r)=>`${e} must have at least ${r} items.`,arrayMax:(e,r)=>`${e} must not exceed ${r} items.`,numberMin:(e,r)=>`${e} must be at least ${r}.`,numberMax:(e,r)=>`${e} must not exceed ${r}.`,fileSize:(e,r)=>`${e} must not exceed ${r}.`,length:(e,r)=>`${e} must be exactly ${r} characters.`},invalid:{invalidString:e=>`${e} must be a string.`,invalidEmail:e=>`${e} must be a valid email address.`,invalidNumber:e=>`${e} must be a number.`,invalidBoolean:e=>`${e} must be a boolean.`,invalidDate:e=>`${e} must be a date.`,invalidArray:e=>`${e} must be an array.`,invalidObject:e=>`${e} must be an object.`,invalidEnum:(e,r)=>`${e} must be one of the following values: ${r.join(", ")}.`,invalidUnion:e=>`${e} must be one of the specified types.`,invalidIntersection:e=>`${e} must be a combination of the specified types.`,invalidTuple:e=>`${e} must be a tuple.`,invalidRecord:e=>`${e} must be a record.`,invalidLiteral:(e,r)=>`${e} must be the literal value: ${r}.`,invalidNull:e=>`${e} must be null.`,invalidUndefined:e=>`${e} must be undefined.`,invalidOptional:e=>`${e} must be optional.`,invalidNullable:e=>`${e} must be nullable.`,invalidPromise:e=>`${e} must be a promise.`,invalidFunction:e=>`${e} must be a function.`,invalidClass:e=>`${e} must be a class.`,invalidUnknown:e=>`${e} must be unknown.`,invalidNever:e=>`${e} must be never.`,invalidVoid:e=>`${e} must be void.`,invalidAny:e=>`${e} must be any.`,invalidUnknownKeys:e=>`${e} must have unknown keys.`,invalidFile:e=>`${e} must be a file.`,invalidFileSize:(e,r)=>`${e} must not exceed ${r} bytes.`,invalidFileType:(e,r)=>`${e} must be of type ${r}.`,invalidUpperCase:e=>`${e} must be at least one upper case.`,invalidLowerCase:e=>`${e} must be at least one lower case.`,invalidNumericCase:e=>`${e} must be at least one number.`,invalidPhoneNumber:e=>`${e} must be a valid phone number.`,invalidUsername:e=>`${e} must contain only letters, numbers, and underscores.`,invalidUsernameOrEmail:e=>`${e} must be a valid username or email address.`}}};var u=(e,r,t)=>{switch(r){case "required":return i.error.required.fieldIsRequired(e);case "invalid":return t||i.error.invalid.invalidString(e);case "limit":return t;default:return `${e} is invalid`}},f=(e,r)=>{let t=z$1.string({error:n=>n.input===void 0?u(e,"required"):u(e,"invalid")});return r?.min&&(t=t.min(r.min,{error:u(e,"limit",i.error.limit.stringMin(e,r.min))})),r?.max&&(t=t.max(r.max,{error:u(e,"limit",i.error.limit.stringMax(e,r.max))})),r?.regex&&(t=t.regex(r.regex,{error:r.regexMsg||u(e,"invalid")})),t},$e=(e,r)=>{let t=z$1.coerce.number({error:n=>n.input===void 0?u(e,"required"):i.error.invalid.invalidNumber(e)});return r?.min&&(t=t.min(r.min,{error:u(e,"limit",i.error.limit.numberMin(e,r.min))})),(t=t.positive({error:u(e,"invalid")})),(t=t.int({error:u(e,"invalid")})),t},we=e=>z$1.boolean({error:()=>u(e,"required")}),Ie=(e,r)=>z$1.enum(r,{error:()=>i.error.invalid.invalidEnum(e,r)});var m=f;var Pe=e=>$e(e,{min:1}),W=we,N=Ie;var A=(e,r)=>{let t=f(e,{min:1}).refine(n=>!isNaN(Number(n)),{error:i.error.invalid.invalidNumber(e)}).transform(n=>Number(n));return r?.min&&(t=t.refine(n=>n>=r.min,{error:u(e,"limit",i.error.limit.numberMin?i.error.limit.numberMin(e,r.min):`${e} must be at least ${r.min}`)})),r?.max&&(t=t.refine(n=>n<=r.max,{error:u(e,"limit",i.error.limit.numberMax?i.error.limit.numberMax(e,r.max):`${e} must be at most ${r.max}`)})),r?.int&&(t=t.refine(n=>Number.isInteger(n),{error:u(e,"invalid",`${e} must be an integer`)})),t};f("Username",{min:1,max:20,regex:/^[a-zA-Z0-9_]*$/,regexMsg:i.error.invalid.invalidUsername("Username")});f("Email",{min:1}).email({error:i.error.invalid.invalidEmail("Email")});f("Username or email",{min:1,max:255}).refine(e=>{let r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,t=/^[a-zA-Z0-9_]*$/;return e.includes("@")?r.test(e):t.test(e)&&e.length<=20},{error:i.error.invalid.invalidUsernameOrEmail("Username or email")});var ke=[{regex:/[A-Z]/,msg:e=>i.error.invalid.invalidUpperCase(e)},{regex:/[a-z]/,msg:e=>i.error.invalid.invalidLowerCase(e)},{regex:/\d/,msg:e=>i.error.invalid.invalidNumericCase(e)}],U=e=>f(e,{min:6}).superRefine((r,t)=>{ke.forEach(n=>{n.regex.test(r)||t.addIssue({code:"custom",message:n.msg(e)});});});U("Password");U("New Password");U("Confirm Password");z$1.object({metaTitle:f("Meta Title",{max:255}).optional(),metaDescription:f("Meta Description",{max:500}).optional(),metaKeywords:f("Meta Keywords").optional(),metaThumbnailId:Pe("Meta Thumbnail ID").optional()});var De=z$1.object({SMTP_HOST:m("SMTP_HOST"),SMTP_PORT:A("SMTP_PORT",{min:1,max:65535,int:true}),SMTP_USER:m("SMTP_USER"),SMTP_PASSWORD:m("SMTP_PASSWORD")}),Ue=z$1.object({GOOGLE_CLIENT_ID:m("GOOGLE_CLIENT_ID"),GOOGLE_CLIENT_SECRET:m("GOOGLE_CLIENT_SECRET"),GOOGLE_CALLBACK_URL:m("GOOGLE_CALLBACK_URL")}),Me=z$1.object({COOKIE_SETTINGS:N("COOKIE_SETTINGS",["locally","globally"]),COOKIE_DOMAIN:m("COOKIE_DOMAIN"),COOKIE_SAME_SITE:N("COOKIE_SAME_SITE",["lax","strict","none"])}),Le=z$1.object({DATABASE_URL:m("DATABASE_URL"),PORT:A("PORT",{min:1,int:true}),SECRET:m("SECRET"),NODE_ENV:N("NODE_ENV",["development","production"]),SESSION_COOKIE_NAME:m("SESSION_COOKIE_NAME"),ORIGIN_URL:m("ORIGIN_URL"),OTP_RESET_EXPIRY:A("OTP_RESET_EXPIRY",{min:1,int:true}),SHOW_OTP:m("SHOW_OTP").refine(e=>W(e)?true:"SHOW_OTP must be a boolean value (true or false)"),API_URL:m("API_URL"),...Me.shape,...De.shape,...Ue.shape}),Z=Le.safeParse(process.env);if(!Z.success){let e=Z.error.issues.map(r=>r.message).join(`
`);console.error(o.red(`Environment validation failed:
${e}`)),process.exit(1);}var je=()=>{try{let e=join(process.cwd(),"package.json"),r=JSON.parse(readFileSync(e,"utf-8")),t=r.dependencies?.express||r.devDependencies?.express;if(t)return t.replace(/[\^~<>=\s]/g,"");let n=join(process.cwd(),"node_modules/express/package.json");return JSON.parse(readFileSync(n,"utf-8")).version}catch{return "unknown"}},X=je;var ze=X();F();var He=async()=>{try{let e=process.env.PORT||8080,r=Fe.address(),t="production";q.listen(e,()=>{console.log(o.magenta(`
\u25B2 Express.js ${ze}`)),console.log(`- Local:        http://localhost:${e}`),console.log(`- Network:      http://${r}:${e}`),console.log(`- Environment:  ${t}`),console.log();});}catch(e){console.error("Failed to start server:",e),process.exit(1);}};He();