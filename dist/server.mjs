import Pe from'ip';import o from'picocolors';import Ee from'cookie-parser';import Re from'cors';import be from'dotenv';import A,{urlencoded}from'express';import Se from'helmet';import {StatusCodes}from'http-status-codes';import {z as z$1}from'zod';import {doubleCsrf}from'csrf-csrf';import fe from'express-rate-limit';import {readFileSync}from'fs';import {join}from'path';function S(e){e.get("/",(r,t)=>{t.status(200).send(`
				<!DOCTYPE html>
				<html lang="en">
				<head>
						<meta charset="UTF-8">
						<meta name="viewport" content="width=device-width, initial-scale=1.0">
						<title>Welcome Page</title>
						<style>
								body {
										font-family: Arial, sans-serif;
										background-color: #f4f4f9;
										color: #333;
										margin: 0;
										padding: 0;
										display: flex;
										justify-content: center;
										align-items: center;
										height: 100vh;
								}
								.container {
										text-align: center;
										background: white;
										padding: 20px;
										border-radius: 10px;
										box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
								}
								h1 {
										color: #4CAF50;
								}
								p {
										font-size: 1.2em;
								}
						</style>
				</head>
				<body>
						<div class="container">
								<h1>Welcome to the Application</h1>
								<p>All the API routes start with <code>/</code></p>
								<p>For example: <code>/auth/login</code></p>
						</div>
				</body>
				</html>
    `);});}var J=new Set([StatusCodes.NO_CONTENT]),W=e=>e>=200&&e<300;var f=class{constructor(r){this.res=r;}successResponse(r,t,n){return this.sendResponse({status:StatusCodes.OK,message:r,data:t,pagination:n})}unauthorizedResponse(r){return this.sendResponse({status:StatusCodes.UNAUTHORIZED,message:r})}forbiddenResponse(r){return this.sendResponse({status:StatusCodes.FORBIDDEN,message:r})}badResponse(r){return this.sendResponse({status:StatusCodes.BAD_REQUEST,message:r})}internalServerError(r="Internal Server Error"){return this.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:r})}sendResponse({status:r,message:t,data:n,pagination:s}){if(J.has(r))return this.res.status(r).end();let a={status:r,success:W(r),message:t,...n!==void 0?{data:n}:{},...s?{pagination:s}:{}};return this.res.status(r).json(a)}};function Q(e,r,t,n){let s=new f(t);if(Y(e,r),e instanceof z$1.ZodError){ee(e,s);return}if(e.name==="ValidationError"){re(e,s);return}if(e.name==="CastError"){te(e,s);return}if(e.name==="MongoError"||e.name==="MongoServerError"){ne(e,s);return}if(e.code==="ECONNREFUSED"){se(e,s);return}if(e.name==="JsonWebTokenError"){oe(e,s);return}if(e.name==="TokenExpiredError"){ie(e,s);return}if(e.name==="SyntaxError"&&e.message.includes("JSON")){ae(e,s);return}if(e.code==="LIMIT_FILE_SIZE"){le(e,s);return}if(e.code==="EBADCSRFTOKEN"){me(e,s);return}if(e.status||e.statusCode){ce(e,s);return}ue(e,s);}function X(e,r){new f(r).sendResponse({status:StatusCodes.NOT_FOUND,message:`Route ${e.method} ${e.originalUrl} not found`});}function P(e){return (r,t,n)=>{Promise.resolve(e(r,t,n)).catch(n);}}function D(e){e.use(X),e.use(Q);}function Y(e,r){let t=new Date().toISOString(),n=r.method,s=r.originalUrl,a=r.get("User-Agent")||"Unknown",l=r.ip||r.socket.remoteAddress||"Unknown";console.error(o.red("=".repeat(80))),console.error(o.red(`\u{1F6A8} ERROR OCCURRED AT: ${t}`)),console.error(o.yellow(`\u{1F4DD} REQUEST: ${n} ${s}`)),console.error(o.cyan(`\u{1F310} IP: ${l}`)),console.error(o.cyan(`\u{1F50D} User-Agent: ${a}`)),console.error(o.red(`\u274C ERROR NAME: ${e.name||"Unknown"}`)),console.error(o.red(`\u{1F4AC} ERROR MESSAGE: ${e.message||"No message"}`)),e.stack&&(console.error(o.gray("\u{1F4DA} STACK TRACE:")),console.error(o.gray(e.stack))),console.error(o.red("=".repeat(80)));}function ee(e,r){let t=e.issues.map(n=>({field:n.path.join("."),message:n.message}));r.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:t}});}function re(e,r){let t=Object.values(e.issues||{}).map(n=>({field:n.path,message:n.message}));r.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:t}});}function te(e,r){r.badResponse(`Invalid ${e.path}: ${e.value}`);}function ne(e,r){if(e.code===11e3){let t=Object.keys(e.keyValue||{})[0];r.sendResponse({status:StatusCodes.CONFLICT,message:`Duplicate value for field: ${t}`});return}r.internalServerError("Database operation failed");}function se(e,r){r.sendResponse({status:StatusCodes.SERVICE_UNAVAILABLE,message:"Database connection failed. Please try again later."});}function oe(e,r){r.unauthorizedResponse("Invalid authentication token");}function ie(e,r){r.unauthorizedResponse("Authentication token has expired");}function ae(e,r){r.badResponse("Invalid JSON format in request body");}function le(e,r){r.badResponse("File size exceeds the allowed limit");}function me(e,r){r.forbiddenResponse("Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.");}function ce(e,r){let t=e.status||e.statusCode||StatusCodes.INTERNAL_SERVER_ERROR,n=e.message||"An error occurred";r.sendResponse({status:t,message:n});}function ue(e,r){r.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Something went wrong. Please try again later."});}function I(){process.on("uncaughtException",e=>{console.error(o.red("\u{1F6A8} UNCAUGHT EXCEPTION:")),console.error(o.red(e.name+": "+e.message)),console.error(o.gray(e.stack)),console.log(o.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("unhandledRejection",(e,r)=>{console.error(o.red("\u{1F6A8} UNHANDLED PROMISE REJECTION:")),console.error(o.red("Reason:"),e),console.error(o.yellow("Promise:"),r),console.log(o.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("SIGTERM",()=>{console.log(o.yellow("\u{1F6D1} SIGTERM received. Starting graceful shutdown...")),process.exit(0);}),process.on("SIGINT",()=>{console.log(o.yellow("\u{1F6D1} SIGINT received. Starting graceful shutdown...")),process.exit(0);});}var U=[".vercel.app",".herokuapp.com",".netlify.app",".render.com",".onrender.com",".surge.sh",".firebaseapp.com",".web.app",".pages.dev",".workers.dev",".glitch.me",".now.sh",".github.io",".gitlab.io",".bitbucket.io",".stackblitz.io",".repl.co",".supabase.co",".railway.app",".ngrok-free.app"];var g=class{static detectInputType(r){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)?"EMAIL":"USERNAME"}static OTPGenerator(r=4){if(r<4)throw new Error("The OTP length must be at least 4.");let t=Math.pow(10,r-1),n=Math.pow(10,r)-1;return Math.floor(Math.random()*(n-t+1)+t)}static OTPExpiry(r=5){let t=new Date;return new Date(t.getTime()+r*6e4)}static sameSiteCookieConfig(){try{let r=l=>/^(\d{1,3}\.){3}\d{1,3}$/.test(l),t=l=>U.some(b=>l.endsWith(b.replace(".",""))),n=()=>{if(process.env.API_URL)try{return new URL(process.env.API_URL).hostname}catch{return process.env.API_URL}return "localhost"},s=process.env.COOKIE_DOMAIN;if(!s)return {sameSite:"lax",secure:!1,domain:n()};let a=s.startsWith(".")?s.substring(1):s;return a==="localhost"||a==="127.0.0.1"||r(a)||s==="localhost"?{sameSite:"lax",secure:!1,domain:n()}:t(a)?{sameSite:"strict",secure:!0,domain:n()}:{sameSite:"lax",secure:!0,domain:s}}catch{return {sameSite:"lax",secure:false}}}};var{generateCsrfToken:M,validateRequest:Ke,doubleCsrfProtection:_,invalidCsrfTokenError:Qe}=doubleCsrf({getSecret:()=>process.env.SECRET,getSessionIdentifier:()=>process.env.SECRET,cookieName:"csrf-token",cookieOptions:{maxAge:36e5,sameSite:g.sameSiteCookieConfig().sameSite,secure:g.sameSiteCookieConfig().secure,...g.sameSiteCookieConfig().domain&&{domain:g.sameSiteCookieConfig().domain}},size:32,errorConfig:{message:"Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.",statusCode:403},getCsrfTokenFromRequest:e=>e.headers["x-csrf-token"]});var L=(()=>{let e=A.Router();return e.get("",P(async(r,t)=>{let n=M(r,t);new f(t).successResponse("CSRF token generated",n);})),e})();var F=[{path:"/csrf-token",router:L}];function y(e,r=""){let t=[];for(let{path:n,router:s}of F){let a=`${r}${n}`;e.use(a,s),s.stack.forEach(l=>{l.route&&Object.keys(l.route.methods).forEach(u=>{t.push({method:u.toUpperCase(),path:`${a}${l.route.path}`});});});}}var z={origin:function(e,r){!e||process.env.ORIGIN_URL.split(",").includes(e)?r(null,true):r(new Error("Not allowed by CORS"));},credentials:true,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","x-csrf-token","ngrok-skip-browser-warning"],maxAge:3600};function T(e){e.use((r,t,n)=>{let{method:s,url:a}=r,l=Date.now();console.log(`${o.green("\u2713")} ${s} ${a}`),t.on("finish",()=>{let b=Date.now()-l,u=t.statusCode,E;u>=500?E=o.red(u.toString()):u>=400?E=o.yellow(u.toString()):u>=300?E=o.cyan(u.toString()):u>=200?E=o.green(u.toString()):E=o.red("500"),console.log(`${o.green("\u2713")} ${s} ${a} ${E} in ${b}ms`);}),n();});}function $(e){let r=fe({windowMs:9e5,max:100,message:"Too many requests, please try again later."});e.use(r);}var w=class{clientDomain=null;serverDomain=null;setClientDomain(r){this.clientDomain=r;}getClientDomain(){return this.clientDomain}setServerDomain(r){this.serverDomain=r;}getServerDomain(){return this.serverDomain}},ve=new w,N=ve;var xe=(e,r,t)=>{let n=e.secure?"https":"http",s=e.headers.origin||e.headers.referer||"Unknown",a=s!=="Unknown"?new URL(s.toString()).origin:"Unknown",l=e.headers.host?`${n}://${e.headers.host}`:"Unknown";N.setClientDomain(a),N.setServerDomain(l),t();},j=xe;be.config();var m=A();m.use(Se());m.use(A.json());m.use(urlencoded({extended:true}));m.use(A.urlencoded({extended:true}));m.use(Ee());m.use(Re(z));T(m);$(m);m.use(j);m.use(_);S(m);y(m);D(m);var H=m;var i={error:{required:{fieldIsRequired:e=>`${e} is required.`},limit:{stringMin:(e,r)=>`${e} must be at least ${r} characters.`,stringMax:(e,r)=>`${e} must not exceed ${r} characters.`,arrayMin:(e,r)=>`${e} must have at least ${r} items.`,arrayMax:(e,r)=>`${e} must not exceed ${r} items.`,numberMin:(e,r)=>`${e} must be at least ${r}.`,numberMax:(e,r)=>`${e} must not exceed ${r}.`,fileSize:(e,r)=>`${e} must not exceed ${r}.`,length:(e,r)=>`${e} must be exactly ${r} characters.`},invalid:{invalidString:e=>`${e} must be a string.`,invalidEmail:e=>`${e} must be a valid email address.`,invalidNumber:e=>`${e} must be a number.`,invalidBoolean:e=>`${e} must be a boolean.`,invalidDate:e=>`${e} must be a date.`,invalidArray:e=>`${e} must be an array.`,invalidObject:e=>`${e} must be an object.`,invalidEnum:(e,r)=>`${e} must be one of the following values: ${r.join(", ")}.`,invalidUnion:e=>`${e} must be one of the specified types.`,invalidIntersection:e=>`${e} must be a combination of the specified types.`,invalidTuple:e=>`${e} must be a tuple.`,invalidRecord:e=>`${e} must be a record.`,invalidLiteral:(e,r)=>`${e} must be the literal value: ${r}.`,invalidNull:e=>`${e} must be null.`,invalidUndefined:e=>`${e} must be undefined.`,invalidOptional:e=>`${e} must be optional.`,invalidNullable:e=>`${e} must be nullable.`,invalidPromise:e=>`${e} must be a promise.`,invalidFunction:e=>`${e} must be a function.`,invalidClass:e=>`${e} must be a class.`,invalidUnknown:e=>`${e} must be unknown.`,invalidNever:e=>`${e} must be never.`,invalidVoid:e=>`${e} must be void.`,invalidAny:e=>`${e} must be any.`,invalidUnknownKeys:e=>`${e} must have unknown keys.`,invalidFile:e=>`${e} must be a file.`,invalidFileSize:(e,r)=>`${e} must not exceed ${r} bytes.`,invalidFileType:(e,r)=>`${e} must be of type ${r}.`,invalidUpperCase:e=>`${e} must be at least one upper case.`,invalidLowerCase:e=>`${e} must be at least one lower case.`,invalidNumericCase:e=>`${e} must be at least one number.`,invalidPhoneNumber:e=>`${e} must be a valid phone number.`,invalidUsername:e=>`${e} must contain only letters, numbers, and underscores.`,invalidUsernameOrEmail:e=>`${e} must be a valid username or email address.`}}};var c=(e,r,t)=>{switch(r){case "required":return i.error.required.fieldIsRequired(e);case "invalid":return t||i.error.invalid.invalidString(e);case "limit":return t;default:return `${e} is invalid`}},d=(e,r)=>{let t=z$1.string({error:n=>n.input===void 0?c(e,"required"):c(e,"invalid")});return r?.min&&(t=t.min(r.min,{error:c(e,"limit",i.error.limit.stringMin(e,r.min))})),r?.max&&(t=t.max(r.max,{error:c(e,"limit",i.error.limit.stringMax(e,r.max))})),r?.regex&&(t=t.regex(r.regex,{error:r.regexMsg||c(e,"invalid")})),t},ye=(e,r)=>{let t=z$1.coerce.number({error:n=>n.input===void 0?c(e,"required"):i.error.invalid.invalidNumber(e)});return r?.min&&(t=t.min(r.min,{error:c(e,"limit",i.error.limit.numberMin(e,r.min))})),(t=t.positive({error:c(e,"invalid")})),(t=t.int({error:c(e,"invalid")})),t};var Te=(e,r)=>z$1.enum(r,{error:()=>i.error.invalid.invalidEnum(e,r)});var p=d;var $e=e=>ye(e,{min:1});var V=Te;var C=(e,r)=>{let t=d(e,{min:1}).refine(n=>!isNaN(Number(n)),{error:i.error.invalid.invalidNumber(e)}).transform(n=>Number(n));return r?.min&&(t=t.refine(n=>n>=r.min,{error:c(e,"limit",i.error.limit.numberMin?i.error.limit.numberMin(e,r.min):`${e} must be at least ${r.min}`)})),r?.max&&(t=t.refine(n=>n<=r.max,{error:c(e,"limit",i.error.limit.numberMax?i.error.limit.numberMax(e,r.max):`${e} must be at most ${r.max}`)})),r?.int&&(t=t.refine(n=>Number.isInteger(n),{error:c(e,"invalid",`${e} must be an integer`)})),t};d("Username",{min:1,max:20,regex:/^[a-zA-Z0-9_]*$/,regexMsg:i.error.invalid.invalidUsername("Username")});d("Email",{min:1}).email({error:i.error.invalid.invalidEmail("Email")});d("Username or email",{min:1,max:255}).refine(e=>{let r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,t=/^[a-zA-Z0-9_]*$/;return e.includes("@")?r.test(e):t.test(e)&&e.length<=20},{error:i.error.invalid.invalidUsernameOrEmail("Username or email")});var we=[{regex:/[A-Z]/,msg:e=>i.error.invalid.invalidUpperCase(e)},{regex:/[a-z]/,msg:e=>i.error.invalid.invalidLowerCase(e)},{regex:/\d/,msg:e=>i.error.invalid.invalidNumericCase(e)}],k=e=>d(e,{min:6}).superRefine((r,t)=>{we.forEach(n=>{n.regex.test(r)||t.addIssue({code:"custom",message:n.msg(e)});});});k("Password");k("New Password");k("Confirm Password");z$1.object({metaTitle:d("Meta Title",{max:255}).optional(),metaDescription:d("Meta Description",{max:500}).optional(),metaKeywords:d("Meta Keywords").optional(),metaThumbnailId:$e("Meta Thumbnail ID").optional()});var Ae=z$1.object({SMTP_HOST:p("SMTP_HOST"),SMTP_PORT:C("SMTP_PORT",{min:1,max:65535,int:true}),SMTP_USER:p("SMTP_USER"),SMTP_PASSWORD:p("SMTP_PASSWORD")}),Ce=z$1.object({COOKIE_DOMAIN:p("COOKIE_DOMAIN")}),ke=z$1.object({DATABASE_URL:p("DATABASE_URL"),PORT:C("PORT",{min:1,int:true}),SECRET:p("SECRET"),NODE_ENV:V("NODE_ENV",["development","production"]),ORIGIN_URL:p("ORIGIN_URL"),API_URL:p("API_URL"),...Ce.shape,...Ae.shape}),q=ke.safeParse(process.env);if(!q.success){let e=q.error.issues.map(r=>r.message).join(`
`);console.error(o.red(`Environment validation failed:
${e}`)),process.exit(1);}var Oe=()=>{try{let e=join(process.cwd(),"package.json"),r=JSON.parse(readFileSync(e,"utf-8")),t=r.dependencies?.express||r.devDependencies?.express;if(t)return t.replace(/[\^~<>=\s]/g,"");let n=join(process.cwd(),"node_modules/express/package.json");return JSON.parse(readFileSync(n,"utf-8")).version}catch{return "unknown"}},Z=Oe;var Ie=Z();I();var Ue=async()=>{try{let e=process.env.PORT||8080,r=Pe.address(),t="production";H.listen(e,()=>{console.log(o.magenta(`
\u25B2 Express.js ${Ie}`)),console.log(`- Local:        http://localhost:${e}`),console.log(`- Network:      http://${r}:${e}`),console.log(`- Environment:  ${t}`),console.log();});}catch(e){console.error("Failed to start server:",e),process.exit(1);}};Ue();